#![recursion_limit = "1024"]

use itertools::Itertools;
use std::process::Command;

fn pad_name(s: &str) -> String {
    let mut res = s.to_string();
    while res.len() < 30 {
        res.push(' ');
    }
    res
}

macro_rules! print_if_feature_enabled {
    () => {};
    ($feature:literal $(, $feats:literal)*)=>{
        if cfg!(target_feature = $feature){
            println!("Enabled feature: {}", pad_name($feature));
        }
        print_if_feature_enabled!($($feats),*)
    }
}

fn main() {
    let output = Command::new("sh")
        .arg("-c")
        .arg("rustc --print target-features")
        .output()
        .expect("Unable to get features");

    let features: Vec<&str> = std::str::from_utf8(&output.stdout)
        .expect("No UTF-8 content")
        .lines()
        .filter(|line| line.starts_with(' '))
        .map(|line| line.trim().split_once(' '))
        .filter(|entry| entry.is_some())
        .map(|entry| entry.unwrap().0)
        .collect();

    features
        .into_iter()
        .unique()
        .for_each(|item| println!("\"{}\",", item));

    print_if_feature_enabled!(
        // arm
        "aclass",
        "mclass",
        "rclass",
        "dsp",
        "neon",
        "crc",
        "crypto",
        "aes",
        "sha2",
        "v5te",
        "v6",
        "v6k",
        "v6t2",
        "v7",
        "v8",
        "vfp2",
        "vfp3",
        "vfp4",
        "fp-armv8",
        "thumb-mode",
        "crt-static",
        "32bit",
        "8msecext",
        "a12",
        "a15",
        "a17",
        "a32",
        "a35",
        "a5",
        "a53",
        "a55",
        "a57",
        "a7",
        "a72",
        "a73",
        "a75",
        "a76",
        "a77",
        "a78c",
        "a8",
        "a9",
        "acquire-release",
        "armv2",
        "armv2a",
        "armv3",
        "armv3m",
        "armv4",
        "armv4t",
        "armv5t",
        "armv5te",
        "armv5tej",
        "armv6",
        "armv6-m",
        "armv6j",
        "armv6k",
        "armv6kz",
        "armv6s-m",
        "armv6t2",
        "armv7-a",
        "armv7-m",
        "armv7-r",
        "armv7e-m",
        "armv7k",
        "armv7s",
        "armv7ve",
        "armv8-a",
        "armv8-m.base",
        "armv8-m.main",
        "armv8-r",
        "armv8.1-a",
        "armv8.1-m.main",
        "armv8.2-a",
        "armv8.3-a",
        "armv8.4-a",
        "armv8.5-a",
        "armv8.6-a",
        "armv8.7-a",
        "avoid-movs-shop",
        "avoid-partial-cpsr",
        "bf16",
        "cde",
        "cdecp0",
        "cdecp1",
        "cdecp2",
        "cdecp3",
        "cdecp4",
        "cdecp5",
        "cdecp6",
        "cdecp7",
        "cheap-predicable-cpsr",
        "cortex-a78",
        "cortex-x1",
        "d32",
        "db",
        "dfb",
        "disable-postra-scheduler",
        "dont-widen-vmovs",
        "dotprod",
        "execute-only",
        "expand-fp-mlx",
        "exynos",
        "fp-armv8d16",
        "fp-armv8d16sp",
        "fp-armv8sp",
        "fp16",
        "fp16fml",
        "fp64",
        "fpao",
        "fpregs",
        "fpregs16",
        "fpregs64",
        "fullfp16",
        "fuse-aes",
        "fuse-literals",
        "harden-sls-blr",
        "harden-sls-retbr",
        "hwdiv",
        "hwdiv-arm",
        "i8mm",
        "iwmmxt",
        "iwmmxt2",
        "krait",
        "kryo",
        "lob",
        "long-calls",
        "loop-align",
        "m3",
        "m7",
        "mp",
        "muxed-units",
        "mve",
        "mve.fp",
        "mve1beat",
        "mve2beat",
        "mve4beat",
        "nacl-trap",
        "neon-fpmovs",
        "neonfp",
        "neoverse-v1",
        "no-branch-predictor",
        "no-movt",
        "no-neg-immediates",
        "noarm",
        "nonpipelined-vfp",
        "perfmon",
        "prefer-ishst",
        "prefer-vmovsr",
        "prof-unpr",
        "r4",
        "r5",
        "r52",
        "r7",
        "ras",
        "read-tp-hard",
        "reserve-r9",
        "ret-addr-stack",
        "sb",
        "slow-fp-brcc",
        "slow-load-D-subreg",
        "slow-odd-reg",
        "slow-vdup32",
        "slow-vgetlni32",
        "slowfpvfmx",
        "slowfpvmlx",
        "soft-float",
        "splat-vfp-neon",
        "strict-align",
        "swift",
        "thumb2",
        "trustzone",
        "use-misched",
        "v4t",
        "v5t",
        "v6m",
        "v7clrex",
        "v8.1a",
        "v8.1m.main",
        "v8.2a",
        "v8.3a",
        "v8.4a",
        "v8.5a",
        "v8.6a",
        "v8.7a",
        "v8m",
        "v8m.main",
        "vfp2sp",
        "vfp3d16",
        "vfp3d16sp",
        "vfp3sp",
        "vfp4d16",
        "vfp4d16sp",
        "vfp4sp",
        "virtualization",
        "vldn-align",
        "vmlx-forwarding",
        "vmlx-hazards",
        "wide-stride-vfp",
        "xscale",
        "zcz",
        // aarch64 --> rustc +nightly --print cfg vs stable !?!???
        "neon",
        "fp",
        "fp16",
        "sve",
        "crc",
        "crypto",
        "ras",
        "lse",
        "rdm",
        "rcpc",
        "rcpc2",
        "dotprod",
        "tme",
        "fhm",
        "dit",
        "ssbs",
        "sb",
        "dpb",
        "dpb2",
        "sve2",
        "sve2-aes",
        "sve2-sm4",
        "sve2-sha3",
        "sve2-bitperm",
        "frintts",
        "rand",
        "bti",
        "mte",
        "jsconv",
        "fcma",
        "aes",
        "sha2",
        "sha3",
        "sm4",
        "v8.1a",
        "v8.2a",
        "v8.3a",
        "v8.4a",
        "v8.5a",
        "crt-static",
        "CONTEXTIDREL2",
        "a35",
        "a53",
        "a55",
        "a57",
        "a64fx",
        "a65",
        "a72",
        "a73",
        "a75",
        "a76",
        "a77",
        "aggressive-fma",
        "alternate-sextload-cvt-f32-pattern",
        "altnzcv",
        "am",
        "amvs",
        "apple-a10",
        "apple-a11",
        "apple-a12",
        "apple-a13",
        "apple-a14",
        "apple-a7",
        "arith-bcc-fusion",
        "arith-cbz-fusion",
        "balance-fp-ops",
        "bf16",
        "brbe",
        "call-saved-x10",
        "call-saved-x11",
        "call-saved-x12",
        "call-saved-x13",
        "call-saved-x14",
        "call-saved-x15",
        "call-saved-x18",
        "call-saved-x8",
        "call-saved-x9",
        "carmel",
        "ccidx",
        "cmp-bcc-fusion",
        "cortex-a78",
        "cortex-a78c",
        "cortex-r82",
        "cortex-x1",
        "custom-cheap-as-move",
        "disable-latency-sched-heuristic",
        "ecv",
        "ete",
        "exynos-cheap-as-move",
        "exynosm3",
        "exynosm4",
        "f32mm",
        "f64mm",
        "falkor",
        "fgt",
        "flagm",
        "force-32bit-jump-tables",
        "fuse-address",
        "fuse-aes",
        "fuse-arith-logic",
        "fuse-crypto-eor",
        "fuse-csel",
        "fuse-literals",
        "harden-sls-blr",
        "harden-sls-retbr",
        "hcx",
        "i8mm",
        "kryo",
        "lor",
        "ls64",
        "lsl-fast",
        "mpam",
        "neoversee1",
        "neoversen1",
        "neoversen2",
        "neoversev1",
        "no-neg-immediates",
        "nv",
        "outline-atomics",
        "pan",
        "pan-rwv",
        "pauth",
        "perfmon",
        "pmu",
        "predictable-select-expensive",
        "predres",
        "reserve-x1",
        "reserve-x10",
        "reserve-x11",
        "reserve-x12",
        "reserve-x13",
        "reserve-x14",
        "reserve-x15",
        "reserve-x18",
        "reserve-x2",
        "reserve-x20",
        "reserve-x21",
        "reserve-x22",
        "reserve-x23",
        "reserve-x24",
        "reserve-x25",
        "reserve-x26",
        "reserve-x27",
        "reserve-x28",
        "reserve-x3",
        "reserve-x30",
        "reserve-x4",
        "reserve-x5",
        "reserve-x6",
        "reserve-x7",
        "reserve-x9",
        "saphira",
        "sel2",
        "slow-misaligned-128store",
        "slow-paired-128",
        "slow-strqro-store",
        "spe",
        "spe-eef",
        "specrestrict",
        "strict-align",
        "tagged-globals",
        "thunderx",
        "thunderx2t99",
        "thunderx3t110",
        "thunderxt81",
        "thunderxt83",
        "thunderxt88",
        "tlb-rmi",
        "tpidr-el1",
        "tpidr-el2",
        "tpidr-el3",
        "tracev8.4",
        "trbe",
        "tsv110",
        "uaops",
        "use-aa",
        "use-experimental-zeroing-pseudos",
        "use-postra-scheduler",
        "use-reciprocal-square-root",
        "v8.6a",
        "v8.7a",
        "v8r",
        "vh",
        "wfxt",
        "xs",
        "zcm",
        "zcz",
        "zcz-fp",
        "zcz-fp-workaround",
        "zcz-gp",
        // x86_64
        "adx",
        "aes",
        "avx",
        "avx2",
        "avx512bf16",
        "avx512bitalg",
        "avx512bw",
        "avx512cd",
        "avx512dq",
        "avx512er",
        "avx512f",
        "avx512gfni",
        "avx512ifma",
        "avx512pf",
        "avx512vaes",
        "avx512vbmi",
        "avx512vbmi2",
        "avx512vl",
        "avx512vnni",
        "avx512vp2intersect",
        "avx512vpclmulqdq",
        "avx512vpopcntdq",
        "bmi1",
        "bmi2",
        "cmpxchg16b",
        "ermsb",
        "f16c",
        "fma",
        "fxsr",
        "lzcnt",
        "movbe",
        "pclmulqdq",
        "popcnt",
        "rdrand",
        "rdseed",
        "rtm",
        "sha",
        "sse",
        "sse2",
        "sse3",
        "sse4.1",
        "sse4.2",
        "sse4a",
        "ssse3",
        "tbm",
        "xsave",
        "xsavec",
        "xsaveopt",
        "xsaves",
        "crt-static",
        "16bit-mode",
        "32bit-mode",
        "3dnow",
        "3dnowa",
        "64bit",
        "64bit-mode",
        "amx-bf16",
        "amx-int8",
        "amx-tile",
        "avxvnni",
        "branchfusion",
        "cldemote",
        "clflushopt",
        "clwb",
        "clzero",
        "cmov",
        "cx8",
        "enqcmd",
        "false-deps-lzcnt-tzcnt",
        "false-deps-popcnt",
        "fast-11bytenop",
        "fast-15bytenop",
        "fast-7bytenop",
        "fast-bextr",
        "fast-gather",
        "fast-hops",
        "fast-lzcnt",
        "fast-scalar-fsqrt",
        "fast-scalar-shift-masks",
        "fast-shld-rotate",
        "fast-variable-shuffle",
        "fast-vector-fsqrt",
        "fast-vector-shift-masks",
        "fma4",
        "fsgsbase",
        "fsrm",
        "hreset",
        "idivl-to-divb",
        "idivq-to-divl",
        "invpcid",
        "kl",
        "lea-sp",
        "lea-uses-ag",
        "lvi-cfi",
        "lvi-load-hardening",
        "lwp",
        "macrofusion",
        "mmx",
        "movdir64b",
        "movdiri",
        "mwaitx",
        "nopl",
        "pad-short-functions",
        "pconfig",
        "pku",
        "prefer-128-bit",
        "prefer-256-bit",
        "prefer-mask-registers",
        "prefetchwt1",
        "prfchw",
        "ptwrite",
        "rdpid",
        "retpoline",
        "retpoline-external-thunk",
        "retpoline-indirect-branches",
        "retpoline-indirect-calls",
        "sahf",
        "serialize",
        "seses",
        "sgx",
        "shstk",
        "slow-3ops-lea",
        "slow-incdec",
        "slow-lea",
        "slow-pmaddwd",
        "slow-pmulld",
        "slow-shld",
        "slow-two-mem-ops",
        "slow-unaligned-mem-16",
        "slow-unaligned-mem-32",
        "soft-float",
        "sse-unaligned-mem",
        "tsxldtrk",
        "uintr",
        "use-aa",
        "use-glm-div-sqrt-costs",
        "vzeroupper",
        "waitpkg",
        "wbnoinvd",
        "widekl",
        "x87",
        "xop"
    );
}
